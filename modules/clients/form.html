<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Migdalin - Formular Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="toast" class="hidden fixed top-6 right-6 z-50 px-6 py-3 rounded-xl shadow-lg text-white font-medium"></div>

    <!-- HEADER -->
    <header class="bg-gradient-to-r from-blue-700 to-blue-900 text-white shadow-xl">
        <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button onclick="window.location.href='index.html'"
                        class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 rounded-lg text-sm transition-all">
                    â† ListÄƒ ClienÈ›i
                </button>
                <h1 id="page-title" class="text-xl font-bold">â• Client Nou</h1>
            </div>
            <div class="flex gap-3">
                <button id="btn-save"
                        class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium shadow transition-all">
                    ğŸ’¾ SalveazÄƒ
                </button>
            </div>
        </div>
    </header>

    <!-- TAB-URI -->
    <div class="bg-white shadow-md border-b sticky top-0 z-10">
        <div class="max-w-5xl mx-auto px-4 overflow-x-auto">
            <div class="flex gap-1 py-2" id="tab-bar">
                <!-- tab-urile sunt generate dinamic -->
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto px-4 py-6">
        <div id="form-content">
            <!-- ConÈ›inut generat dinamic per tab -->
        </div>
    </div>

    <script type="module">
        import { initializeApp }     from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged }
                                     from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp, updateDoc, arrayUnion }
                                     from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey:            "AIzaSyAgPHpBzoZb2sUvSkG-0PSf8wxxaY_JJQE",
            authDomain:        "crm-migdalin.firebaseapp.com",
            projectId:         "crm-migdalin",
            storageBucket:     "crm-migdalin.firebasestorage.app",
            messagingSenderId: "498188629124",
            appId:             "1:498188629124:web:b0cf5d5585d2cd4af3fed1"
        };

        const app  = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db   = getFirestore(app);

        // â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let currentUser     = null;
        let currentUserData = null;
        let clientId        = null;  // null = client nou
        let clientData      = {};    // datele existente (pentru editare)
        let activeTab       = 0;

        const urlParams = new URLSearchParams(window.location.search);
        clientId = urlParams.get('id') || null;

        // â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const el    = id => document.getElementById(id);
        const toast = (msg, ok = true) => {
            const t = el('toast');
            t.textContent = msg;
            t.className = `fixed top-6 right-6 z-50 px-6 py-3 rounded-xl shadow-lg text-white font-medium
                           ${ok ? 'bg-green-600' : 'bg-red-600'}`;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3500);
        };

        const inp = id => el(id)?.value?.trim() || '';

        // â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const TABS = [
            { id: 'identificare',    label: 'ğŸ¢ Identificare'     },
            { id: 'contact',         label: 'ğŸ“ Contact'          },
            { id: 'logistica',       label: 'ğŸšš LogisticÄƒ'        },
            { id: 'structura',       label: 'ğŸ—ï¸ StructurÄƒ InternÄƒ' },
            { id: 'comercial',       label: 'ğŸ’¼ Date Comerciale'  },
        ];

        function renderTabs() {
            el('tab-bar').innerHTML = TABS.map((t, i) => `
                <button onclick="switchTab(${i})" id="tab-btn-${i}"
                        class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all
                               ${i === activeTab
                                 ? 'bg-blue-600 text-white shadow'
                                 : 'text-gray-600 hover:bg-gray-100'}">
                    ${t.label}
                </button>`).join('');
        }

        window.switchTab = (i) => {
            activeTab = i;
            renderTabs();
            renderTabContent();
        };

        // â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        onAuthStateChanged(auth, async user => {
            if (!user) { window.location.href = '../auth/index.html'; return; }
            currentUser = user;
            const snap  = await getDoc(doc(db, 'users', user.uid));
            if (!snap.exists()) { window.location.href = '../auth/index.html'; return; }
            currentUserData = snap.data();

            if (clientId) {
                el('page-title').textContent = 'âœï¸ Editare Client';
                const cSnap = await getDoc(doc(db, 'clients', clientId));
                if (cSnap.exists()) clientData = cSnap.data();
            }

            renderTabs();
            renderTabContent();
        });

        // â”€â”€â”€ RENDER CONÈšINUT TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderTabContent() {
            const tab = TABS[activeTab].id;
            const c   = clientData;

            const card = (title, content) => `
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-5 pb-2 border-b">${title}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">${content}</div>
                </div>`;

            const field = (label, id, type = 'text', value = '', opts = '') => `
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">${label}</label>
                    <input type="${type}" id="${id}" value="${esc(value)}" ${opts}
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors text-sm" />
                </div>`;

            const fieldFull = (label, id, type = 'text', value = '', opts = '') => `
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">${label}</label>
                    <input type="${type}" id="${id}" value="${esc(value)}" ${opts}
                           class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors text-sm" />
                </div>`;

            const select = (label, id, options, value = '') => `
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">${label}</label>
                    <select id="${id}" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors text-sm">
                        <option value="">â€” SelecteazÄƒ â€”</option>
                        ${options.map(o => `<option ${value===o?'selected':''}>${o}</option>`).join('')}
                    </select>
                </div>`;

            const SUBSEGMENTE = {
    'HoReCa':                ['Restaurant','Cafenea','Bar / Pub','Hotel','Catering','Fast-food','Pizzerie'],
    'Retail alimentar':      ['Magazin mixt','Magazin de cartier','Mini-market','Supermarket','Hypermarket'],
    'DistribuÈ›ie':           ['Distribuitor local','Cash & Carry','Angrosist'],
    'Corporate / InstituÈ›ional': ['È˜coli','Spitale','CÄƒmine','InstituÈ›ii publice'],
};
            
            const textarea = (label, id, value = '', rows = 3) => `
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">${label}</label>
                    <textarea id="${id}" rows="${rows}"
                              class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors text-sm">${esc(value)}</textarea>
                </div>`;

            let html = '';

            if (tab === 'identificare') {
                html = card('ğŸ¢ Date de Identificare', `
                    ${field('Nume Companie *', 'companyName', 'text', c.companyName || '', 'required')}
                    ${field('CUI / CIF *', 'cui', 'text', c.cui || '', 'required')}
                    ${field('Nr. Reg. ComerÈ›ului (J...)', 'regCom', 'text', c.regCom || '')}
                    ${select('Forma JuridicÄƒ', 'legalForm',
                        ['SRL','SA','PFA','RA','SNC','SCS','Regie AutonomÄƒ','InstituÈ›ie PublicÄƒ'], c.legalForm || '')}
                    ${field('Cod CAEN', 'caenCode', 'text', c.caenCode || '')}
                    ${field('An ÃnfiinÈ›are', 'foundedYear', 'number', c.foundedYear || '')}
                    ${select('Dimensiune Companie', 'companySize',
                        ['Micro (1-9 ang.)','MicÄƒ (10-49 ang.)','Mijlocie (50-249 ang.)','Mare (250+ ang.)'], c.companySize || '')}
                    ${select('Segment', 'segment',
                        ['Alimentar','Non-alimentar','Servicii','ProducÈ›ie','DistribuÈ›ie','Retail','HoReCa','InstituÈ›ional'], c.segment || '')}
                    
                    <div>
    <label class="block text-sm font-semibold text-gray-700 mb-1">Sub-segment</label>
    <select id="subSegment" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors text-sm">
        <option value="">â€” SelecteazÄƒ segment mai Ã®ntÃ¢i â€”</option>
    </select>
</div>
                    
                    ${select('Sursa Clientului', 'sourceType',
                        ['ReferinÈ›Äƒ','Web / Online','Apel telefonic','VizitÄƒ spontanÄƒ','Alt agent','Eveniment / TÃ¢rg','Altele'], c.sourceType || '')}
                `);

            } else if (tab === 'contact') {
                html = card('ğŸ‘¤ Contact Principal', `
                    ${field('Nume Contact Principal *', 'contactName', 'text', c.contactName || '', 'required')}
                    ${field('FuncÈ›ie', 'contactRole', 'text', c.contactRole || '')}
                    ${field('Telefon Mobil *', 'phoneMobile', 'tel', c.phoneMobile || '', 'required')}
                    ${field('Telefon Fix', 'phoneFixed', 'tel', c.phoneFixed || '')}
                    ${field('Email Principal *', 'emailMain', 'email', c.emailMain || '', 'required')}
                    ${field('Site Web', 'website', 'url', c.website || '')}
                `) +
                card('ğŸ‘¤ Contact Secundar', `
                    ${field('Nume Contact Secundar', 'contact2Name', 'text', c.contact2Name || '')}
                    ${field('FuncÈ›ie', 'contact2Role', 'text', c.contact2Role || '')}
                    ${field('Telefon', 'contact2Phone', 'tel', c.contact2Phone || '')}
                    ${field('Email', 'contact2Email', 'email', c.contact2Email || '')}
                `) +
                card('ğŸ“ AdresÄƒ È™i LocaÈ›ie', `
                    ${fieldFull('AdresÄƒ Sediu Social', 'addressHQ', 'text', c.addressHQ || '')}
                    ${field('OraÈ™ *', 'city', 'text', c.city || '', 'required')}
                    ${field('JudeÈ› *', 'county', 'text', c.county || '', 'required')}
                    ${field('ZonÄƒ ComercialÄƒ', 'commercialZone', 'text', c.commercialZone || '')}
                `);

            } else if (tab === 'logistica') {
                html = card('ğŸšš Date Logistice', `
                    ${fieldFull('AdresÄƒ Livrare (dacÄƒ diferÄƒ de sediu)', 'addressDelivery', 'text', c.addressDelivery || '')}
                    ${field('PersoanÄƒ Contact Livrare', 'deliveryContact', 'text', c.deliveryContact || '')}
                    ${field('Telefon Contact Livrare', 'deliveryPhone', 'tel', c.deliveryPhone || '')}
                    ${field('Program Lucru / Ore Livrare', 'workingHours', 'text', c.workingHours || '')}
                    ${select('Tip Transport Preferat', 'transportType',
                        ['Propriu (al clientului)','Al nostru','Curier','Mixt'], c.transportType || '')}
                    ${select('Depozit Propriu', 'hasWarehouse',
                        ['Da','Nu'], c.hasWarehouse || '')}
                `);

            } else if (tab === 'structura') {
                html = card('ğŸ—ï¸ StructurÄƒ InternÄƒ CRM', `
                    ${field('Agent VÃ¢nzÄƒri Responsabil', 'agentName', 'text',
                        clientId ? (c.agentName || '') : (currentUserData.name || currentUserData.email))}
                    ${field('Director Zonal', 'directorZonalName', 'text', c.directorZonalName || '')}
                    ${field('Depozit de Aprovizionare', 'supplyDepot', 'text', c.supplyDepot || '')}
                    ${field('RutÄƒ / Circuit VizitÄƒ', 'visitRoute', 'text', c.visitRoute || '')}
                    ${select('FrecvenÈ›a Vizitelor', 'visitFrequency',
                        ['SÄƒptÄƒmÃ¢nal','Bilunar','Lunar','La cerere'], c.visitFrequency || '')}
                    ${field('Data Atribuirii', 'assignedDate', 'date', c.assignedDate || today())}
                `);

            } else if (tab === 'comercial') {
                html = card('ğŸ’¼ Date Comerciale', `
                    ${select('Status Client *', 'status',
                        ['Activ','Inactiv','PotenÈ›ial','Blocat'], c.status || 'PotenÈ›ial')}
                    ${select('Tip Client', 'clientType',
                        ['En-gros','Retail','HoReCa','InstituÈ›ie','ProducÄƒtor'], c.clientType || '')}
                    ${select('Nivel Prioritate', 'priority',
                        ['A - Strategic','B','C'], c.priority || '')}
                    ${select('MonedÄƒ', 'currency',
                        ['RON','EUR','USD'], c.currency || 'RON')}
                    ${field('Discount Standard (%)', 'discount', 'number', c.discount || '')}
                    ${field('LimitÄƒ Credit (RON)', 'creditLimit', 'number', c.creditLimit || '')}
                    ${field('Termen de PlatÄƒ (zile)', 'paymentDays', 'number', c.paymentDays || '30')}
                    ${select('Modalitate PlatÄƒ', 'paymentMethod',
                        ['Cash','OP (Ordin de PlatÄƒ)','CEC','Bilet la Ordin','Mixt'], c.paymentMethod || '')}
                    ${textarea('CondiÈ›ii Comerciale Speciale', 'specialTerms', c.specialTerms || '')}
                    ${textarea('NotiÈ›e Generale', 'notes', c.notes || '')}
                `);
            }

            el('form-content').innerHTML = html;
            // Logica sub-segmente dinamice
if (activeTab === 0) {
    const segSel = document.getElementById('segment');
    const subSel = document.getElementById('subSegment');

    const populateSub = (segVal, currentSub) => {
        const opts = SUBSEGMENTE[segVal] || [];
        subSel.innerHTML = opts.length
            ? `<option value="">â€” SelecteazÄƒ â€”</option>` +
              opts.map(o => `<option ${currentSub===o?'selected':''}>${o}</option>`).join('')
            : `<option value="">â€” FÄƒrÄƒ sub-segmente â€”</option>`;
    };

    // PopuleazÄƒ la Ã®ncÄƒrcare dacÄƒ existÄƒ deja o valoare
    populateSub(segSel?.value || '', c.subSegment || '');

    // ActualizeazÄƒ cÃ¢nd se schimbÄƒ segmentul
    segSel?.addEventListener('change', () => populateSub(segSel.value, ''));
}
        }

        // â”€â”€â”€ COLECTARE DATE DIN FORMULAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function collectFormData() {
            const g = id => el(id)?.value?.trim() || '';
            return {
                // Identificare
                companyName:    g('companyName'),
                cui:            g('cui'),
                regCom:         g('regCom'),
                legalForm:      g('legalForm'),
                caenCode:       g('caenCode'),
                foundedYear:    g('foundedYear'),
                companySize:    g('companySize'),
                segment:        g('segment'),
                subSegment:     g('subSegment'),
                sourceType:     g('sourceType'),
                // Contact
                contactName:    g('contactName'),
                contactRole:    g('contactRole'),
                phoneMobile:    g('phoneMobile'),
                phoneFixed:     g('phoneFixed'),
                emailMain:      g('emailMain'),
                website:        g('website'),
                contact2Name:   g('contact2Name'),
                contact2Role:   g('contact2Role'),
                contact2Phone:  g('contact2Phone'),
                contact2Email:  g('contact2Email'),
                addressHQ:      g('addressHQ'),
                city:           g('city'),
                county:         g('county'),
                commercialZone: g('commercialZone'),
                // LogisticÄƒ
                addressDelivery:g('addressDelivery'),
                deliveryContact:g('deliveryContact'),
                deliveryPhone:  g('deliveryPhone'),
                workingHours:   g('workingHours'),
                transportType:  g('transportType'),
                hasWarehouse:   g('hasWarehouse'),
                // StructurÄƒ internÄƒ
                agentId:        clientId ? (clientData.agentId || currentUser.uid) : currentUser.uid,
                agentName:      g('agentName') || currentUserData.name,
                directorZonalName: g('directorZonalName'),
                directorZonalId:   clientData.directorZonalId || currentUserData.managerId || null,
                supplyDepot:    g('supplyDepot'),
                visitRoute:     g('visitRoute'),
                visitFrequency: g('visitFrequency'),
                assignedDate:   g('assignedDate'),
                // Comercial
                status:         g('status') || 'PotenÈ›ial',
                clientType:     g('clientType'),
                priority:       g('priority'),
                currency:       g('currency') || 'RON',
                discount:       g('discount'),
                creditLimit:    g('creditLimit'),
                paymentDays:    g('paymentDays'),
                paymentMethod:  g('paymentMethod'),
                specialTerms:   g('specialTerms'),
                notes:          g('notes'),
            };
        }

        // â”€â”€â”€ SALVARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        el('btn-save').addEventListener('click', async () => {
            // Validare cÃ¢mpuri obligatorii
            const required = [
                ['companyName', 'Identificare â†’ Nume Companie'],
                ['cui',         'Identificare â†’ CUI'],
                ['contactName', 'Contact â†’ Nume Contact Principal'],
                ['phoneMobile', 'Contact â†’ Telefon Mobil'],
                ['emailMain',   'Contact â†’ Email Principal'],
                ['city',        'Contact â†’ OraÈ™'],
                ['county',      'Contact â†’ JudeÈ›'],
            ];

            // Ne asigurÄƒm cÄƒ toate tab-urile au fost vizitate cel puÈ›in o datÄƒ
            // ForÈ›Äƒm render pe fiecare tab pentru a colecta datele
            const originalTab = activeTab;
            const data = {};

            for (let i = 0; i < TABS.length; i++) {
                activeTab = i;
                renderTabContent();
                Object.assign(data, collectFormData());
            }

            // RestaurÄƒm tab-ul activ
            activeTab = originalTab;
            renderTabs();
            renderTabContent();

            // Validare
            for (const [field, label] of required) {
                if (!data[field]) {
                    toast(`âš ï¸ CÃ¢mp obligatoriu lipsÄƒ: ${label}`, false);
                    return;
                }
            }

            el('btn-save').disabled    = true;
            el('btn-save').textContent = 'Se salveazÄƒ...';

            try {
                if (clientId) {
                    // EDITARE
                    const changes = [];
                    for (const key of Object.keys(data)) {
                        const oldVal = String(clientData[key] || '');
                        const newVal = String(data[key] || '');
                        if (oldVal !== newVal) {
                            changes.push({ field: key, from: oldVal, to: newVal });
                        }
                    }

                    await updateDoc(doc(db, 'clients', clientId), {
                        ...data,
                        updatedAt:   serverTimestamp(),
                        updatedBy:   currentUser.uid,
                        updatedName: currentUserData.name || currentUserData.email,
                        auditLog:    arrayUnion({
                            timestamp: new Date().toISOString(),
                            user:      currentUserData.name || currentUserData.email,
                            action:    'editare',
                            changes:   changes
                        })
                    });
                    toast('âœ… Client actualizat cu succes!');
                } else {
                    // CREARE
                    await addDoc(collection(db, 'clients'), {
                        ...data,
                        createdAt:   serverTimestamp(),
                        createdBy:   currentUser.uid,
                        createdName: currentUserData.name || currentUserData.email,
                        updatedAt:   serverTimestamp(),
                        updatedBy:   currentUser.uid,
                        auditLog:    [{
                            timestamp: new Date().toISOString(),
                            user:      currentUserData.name || currentUserData.email,
                            action:    'creare',
                            changes:   []
                        }]
                    });
                    toast('âœ… Client adÄƒugat cu succes!');
                }

                setTimeout(() => window.location.href = 'index.html', 1200);

            } catch (e) {
                toast('âŒ Eroare la salvare: ' + e.message, false);
            } finally {
                el('btn-save').disabled    = false;
                el('btn-save').textContent = 'ğŸ’¾ SalveazÄƒ';
            }
        });

        // â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function esc(str) {
            return String(str || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
        }
        function today() {
            return new Date().toISOString().split('T')[0];
        }
    </script>
</body>
</html>
