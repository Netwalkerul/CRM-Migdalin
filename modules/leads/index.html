<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Migdalin - Leaduri</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<div id="toast" class="hidden fixed top-6 right-6 z-50 px-6 py-3 rounded-xl shadow-lg text-white font-medium"></div>

<!-- HEADER -->
<header class="bg-gradient-to-r from-orange-600 to-orange-800 text-white shadow-xl">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <button onclick="window.location.href='../auth/index.html'"
                    class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 rounded-lg text-sm">â† Ãnapoi</button>
            <div>
                <h1 class="text-xl font-bold">ğŸ¯ Modul Leaduri</h1>
                <p id="user-info" class="text-orange-200 text-xs"></p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="window.location.href='report.html'"
                    class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 rounded-lg text-sm font-medium">
                ğŸ“Š Rapoarte
            </button>
            <button onclick="window.location.href='form.html'"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium shadow transition-colors">
                â• Lead Nou
            </button>
        </div>
    </div>
</header>

<!-- VIEW TOGGLE + FILTRE -->
<div class="max-w-7xl mx-auto px-4 py-4">

    <!-- Toggle vizualizare -->
    <div class="flex items-center justify-between mb-4">
        <div class="flex bg-white rounded-xl shadow p-1 gap-1">
            <button id="btn-view-table" onclick="setView('table')"
                    class="px-4 py-2 rounded-lg text-sm font-medium transition-all bg-orange-600 text-white">
                ğŸ“‹ Tabel
            </button>
            <button id="btn-view-kanban" onclick="setView('kanban')"
                    class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-gray-100">
                ğŸ—‚ï¸ Pipeline
            </button>
        </div>
        <button onclick="exportCSV()"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
            ğŸ“¥ Export CSV
        </button>
    </div>

    <!-- FILTRE -->
    <div class="bg-white rounded-2xl shadow-lg p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
            <div class="lg:col-span-2">
                <input id="filter-search" type="text" placeholder="CautÄƒ dupÄƒ nume, companie, email..."
                       class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-orange-500 text-sm">
            </div>
            <select id="filter-status" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-orange-500 text-sm">
                <option value="">Toate statusurile</option>
                <option>Nou</option>
                <option>Contactat</option>
                <option>Calificat</option>
                <option>Pierdut</option>
                <option>Convertit</option>
            </select>
            <select id="filter-source" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-orange-500 text-sm">
                <option value="">Toate sursele</option>
                <option>Facebook</option>
                <option>Recomandare</option>
                <option>Site</option>
                <option>TÃ¢rg</option>
                <option>Altele</option>
            </select>
            <select id="filter-score" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-orange-500 text-sm">
                <option value="">Toate scorurile</option>
                <option value="hot">ğŸŸ¢ Fierbinte (61-100)</option>
                <option value="warm">ğŸŸ¡ Cald (31-60)</option>
                <option value="cold">ğŸ”´ Rece (0-30)</option>
            </select>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-3">
            <select id="filter-agent" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-orange-500 text-sm agent-col hidden">
                <option value="">ToÈ›i agenÈ›ii</option>
            </select>
            <select id="filter-horizon" class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-orange-500 text-sm">
                <option value="">Toate orizonturile</option>
                <option>Imediat</option>
                <option>3 luni</option>
                <option>6 luni</option>
                <option>9 luni</option>
            </select>
            <div class="flex gap-2">
                <button onclick="applyFilters()"
                        class="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                    ğŸ” FiltreazÄƒ
                </button>
                <button onclick="resetFilters()" class="px-4 py-2 border-2 border-gray-300 hover:bg-gray-100 rounded-lg text-sm">âœ•</button>
            </div>
        </div>
    </div>

    <!-- STATISTICI -->
    <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-6">
        <div class="bg-white rounded-xl shadow p-4 border-l-4 border-orange-400">
            <p class="text-xs text-gray-500">Total Leaduri</p>
            <p id="stat-total" class="text-2xl font-bold text-orange-600 mt-1">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4 border-l-4 border-blue-400">
            <p class="text-xs text-gray-500">Noi</p>
            <p id="stat-new" class="text-2xl font-bold text-blue-600 mt-1">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4 border-l-4 border-yellow-400">
            <p class="text-xs text-gray-500">CalificaÈ›i</p>
            <p id="stat-qualified" class="text-2xl font-bold text-yellow-600 mt-1">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4 border-l-4 border-green-500">
            <p class="text-xs text-gray-500">ConvertiÈ›i</p>
            <p id="stat-converted" class="text-2xl font-bold text-green-600 mt-1">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4 border-l-4 border-green-400">
            <p class="text-xs text-gray-500">ğŸŸ¢ FierbinÈ›i</p>
            <p id="stat-hot" class="text-2xl font-bold text-green-600 mt-1">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4 border-l-4 border-indigo-400">
            <p class="text-xs text-gray-500">Valoare PotenÈ›ialÄƒ</p>
            <p id="stat-value" class="text-lg font-bold text-indigo-600 mt-1">0 RON</p>
        </div>
    </div>

    <!-- VIEW: TABEL -->
    <div id="view-table">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Companie / Contact</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">SursÄƒ</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Scor</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Valoare Est.</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Orizont</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase agent-col hidden">Agent</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">AcÈ›iuni</th>
                        </tr>
                    </thead>
                    <tbody id="leads-tbody" class="divide-y divide-gray-100">
                        <tr><td colspan="9" class="text-center py-16 text-gray-400">
                            <div class="text-5xl mb-3">â³</div><p>Se Ã®ncarcÄƒ...</p>
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- VIEW: KANBAN -->
    <div id="view-kanban" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4" id="kanban-board"></div>
    </div>
</div>

<!-- MODAL detalii lead -->
<div id="modal-lead" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center px-6 py-4 border-b">
            <h2 class="text-lg font-bold text-gray-800">ğŸ¯ Detalii Lead</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">Ã—</button>
        </div>
        <div id="modal-content" class="px-6 py-4"></div>
        <div class="px-6 py-4 border-t flex justify-between items-center">
            <button id="modal-convert-btn"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                ğŸ”„ ConverteÈ™te Ã®n Client
            </button>
            <div class="flex gap-2">
                <button id="modal-edit-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium">âœï¸ EditeazÄƒ</button>
                <button onclick="closeModal()" class="px-4 py-2 border-2 border-gray-300 hover:bg-gray-100 rounded-lg text-sm">Ãnchide</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL conversie lead â†’ client -->
<div id="modal-convert" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
        <div class="flex justify-between items-center px-6 py-4 border-b">
            <h2 class="text-lg font-bold text-gray-800">ğŸ”„ ConverteÈ™te Lead Ã®n Client</h2>
            <button onclick="closeConvertModal()" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
        </div>
        <div class="px-6 py-4 space-y-4">
            <div class="bg-green-50 border border-green-200 rounded-xl p-3 text-sm text-green-800">
                âœ… Leadul va fi marcat ca <strong>Convertit</strong> È™i un client nou va fi creat automat Ã®n modulul ClienÈ›i.
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">JudeÈ› / Localitate</label>
                <input id="conv-location" type="text" placeholder="ex: IaÈ™i"
                       class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-orange-500 text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">CUI / CIF (opÈ›ional)</label>
                <input id="conv-cui" type="text" placeholder="ex: RO12345678"
                       class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-orange-500 text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">NotiÈ›e iniÈ›iale</label>
                <textarea id="conv-notes" rows="3" placeholder="InformaÈ›ii relevante pentru dosarul clientului..."
                          class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-orange-500 text-sm resize-none"></textarea>
            </div>
        </div>
        <div class="px-6 py-4 border-t flex justify-end gap-3">
            <button onclick="closeConvertModal()" class="px-4 py-2 border-2 border-gray-300 hover:bg-gray-100 rounded-lg text-sm">AnuleazÄƒ</button>
            <button onclick="confirmConvert()"
                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-sm font-medium">
                âœ… ConfirmÄƒ Conversia
            </button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged }
                           from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, orderBy,
         doc, getDoc, deleteDoc, updateDoc, addDoc, Timestamp }
                           from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAgPHpBzoZb2sUvSkG-0PSf8wxxaY_JJQE",
    authDomain: "crm-migdalin.firebaseapp.com",
    projectId: "crm-migdalin",
    storageBucket: "crm-migdalin.firebasestorage.app",
    messagingSenderId: "498188629124",
    appId: "1:498188629124:web:b0cf5d5585d2cd4af3fed1"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const ROLES = {
    admin:{level:99}, presedinte:{level:6}, director_general:{level:5},
    director_regional:{level:4}, director_zonal:{level:3}, agent:{level:2}
};

const STATUS_COLORS = {
    'Nou':       'bg-blue-100 text-blue-800',
    'Contactat': 'bg-yellow-100 text-yellow-800',
    'Calificat': 'bg-purple-100 text-purple-800',
    'Pierdut':   'bg-red-100 text-red-800',
    'Convertit': 'bg-green-100 text-green-800'
};
const SOURCE_ICONS = {
    'Facebook':'ğŸ“˜','Recomandare':'ğŸ¤','Site':'ğŸŒ','TÃ¢rg':'ğŸª','Altele':'ğŸ“Œ'
};
const KANBAN_COLS = ['Nou','Contactat','Calificat','Pierdut','Convertit'];
const KANBAN_COLORS = {
    'Nou':       'border-blue-400 bg-blue-50',
    'Contactat': 'border-yellow-400 bg-yellow-50',
    'Calificat': 'border-purple-400 bg-purple-50',
    'Pierdut':   'border-red-400 bg-red-50',
    'Convertit': 'border-green-500 bg-green-50'
};

let currentUser = null, currentUserData = null;
let allLeads = [], filteredLeads = [];
let currentView = 'table';
let convertLeadId = null;

const el    = id => document.getElementById(id);
const toast = (msg, ok=true) => {
    const t = el('toast');
    t.textContent = msg;
    t.className = `fixed top-6 right-6 z-50 px-6 py-3 rounded-xl shadow-lg text-white font-medium ${ok?'bg-green-600':'bg-red-600'}`;
    t.classList.remove('hidden');
    setTimeout(()=>t.classList.add('hidden'), 3500);
};

// â”€â”€ LEAD SCORING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcScore(lead) {
    let s = 0;
    const budget = parseFloat(lead.budget) || 0;
    if (budget > 50000)      s += 20;
    else if (budget > 10000) s += 15;
    else if (budget > 5000)  s += 10;
    else if (budget > 0)     s += 5;

    if (lead.horizon === 'Imediat')  s += 30;
    else if (lead.horizon === '3 luni') s += 20;
    else if (lead.horizon === '6 luni') s += 10;
    else if (lead.horizon === '9 luni') s += 5;

    if (lead.source === 'Recomandare') s += 20;
    else if (lead.source === 'TÃ¢rg')  s += 15;
    else if (lead.source === 'Site')  s += 10;
    else if (lead.source === 'Facebook') s += 8;

    if (lead.status === 'Calificat')  s += 20;
    else if (lead.status === 'Contactat') s += 10;

    if (lead.email && lead.phone) s += 10;
    return Math.min(s, 100);
}

function scoreBadge(score) {
    if (score >= 61) return `<span class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800">ğŸŸ¢ ${score}</span>`;
    if (score >= 31) return `<span class="px-2 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800">ğŸŸ¡ ${score}</span>`;
    return `<span class="px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800">ğŸ”´ ${score}</span>`;
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthStateChanged(auth, async user => {
    if (!user) { window.location.href = '../auth/index.html'; return; }
    currentUser = user;
    const snap = await getDoc(doc(db,'users',user.uid));
    if (!snap.exists()) { window.location.href = '../auth/index.html'; return; }
    currentUserData = snap.data();
    el('user-info').textContent = currentUserData.name + ' Â· ' + currentUserData.role;

    const level = ROLES[currentUserData.role]?.level || 0;
    if (level > 2) {
        document.querySelectorAll('.agent-col').forEach(e => e.classList.remove('hidden'));
        await loadAgentsFilter();
    }
    await loadLeads();
});

async function loadAgentsFilter() {
    const level = ROLES[currentUserData.role]?.level || 0;
    const q = level >= 4
        ? query(collection(db,'users'), where('role','==','agent'))
        : query(collection(db,'users'), where('role','==','agent'), where('managerId','==',currentUser.uid));
    const snap = await getDocs(q);
    const sel = el('filter-agent');
    snap.forEach(d => {
        const o = document.createElement('option');
        o.value = d.id; o.textContent = d.data().name || d.data().email;
        sel.appendChild(o);
    });
}

// â”€â”€ LOAD LEADURI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLeads() {
    try {
        const level = ROLES[currentUserData.role]?.level || 0;
        let q;
        if (level >= 4)      q = query(collection(db,'leads'), orderBy('createdAt','desc'));
        else if (level === 3) q = query(collection(db,'leads'), where('directorZonalId','==',currentUser.uid), orderBy('createdAt','desc'));
        else                  q = query(collection(db,'leads'), where('agentId','==',currentUser.uid), orderBy('createdAt','desc'));

        const snap = await getDocs(q);
        allLeads = [];
        snap.forEach(d => {
            const lead = {id:d.id,...d.data()};
            lead.score = calcScore(lead);
            allLeads.push(lead);
        });
        updateStats(allLeads);
        applyFilters();
    } catch(e) {
        el('leads-tbody').innerHTML = `<tr><td colspan="9" class="text-center py-8 text-red-500">Eroare: ${e.message}</td></tr>`;
    }
}

// â”€â”€ STATISTICI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats(leads) {
    el('stat-total').textContent     = leads.length;
    el('stat-new').textContent       = leads.filter(l=>l.status==='Nou').length;
    el('stat-qualified').textContent = leads.filter(l=>l.status==='Calificat').length;
    el('stat-converted').textContent = leads.filter(l=>l.status==='Convertit').length;
    el('stat-hot').textContent       = leads.filter(l=>l.score>=61).length;
    const val = leads.reduce((sum,l)=>sum+parseFloat(l.estimatedValue||0),0);
    el('stat-value').textContent     = val.toLocaleString('ro-RO',{maximumFractionDigits:0}) + ' RON';
}

// â”€â”€ FILTRE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.applyFilters = () => {
    const search  = el('filter-search').value.toLowerCase().trim();
    const status  = el('filter-status').value;
    const source  = el('filter-source').value;
    const scoreF  = el('filter-score').value;
    const agent   = el('filter-agent').value;
    const horizon = el('filter-horizon').value;

    filteredLeads = allLeads.filter(l => {
        const ms = !search || (l.companyName||'').toLowerCase().includes(search) ||
                   (l.contactName||'').toLowerCase().includes(search) ||
                   (l.email||'').toLowerCase().includes(search) ||
                   (l.leadId||'').toLowerCase().includes(search);
        const mst = !status  || l.status  === status;
        const msr = !source  || l.source  === source;
        const ma  = !agent   || l.agentId === agent;
        const mh  = !horizon || l.horizon === horizon;
        let msc = true;
        if (scoreF === 'hot')  msc = l.score >= 61;
        if (scoreF === 'warm') msc = l.score >= 31 && l.score <= 60;
        if (scoreF === 'cold') msc = l.score <= 30;
        return ms && mst && msr && ma && mh && msc;
    });

    currentView === 'table' ? renderTable() : renderKanban();
};

window.resetFilters = () => {
    ['filter-search','filter-status','filter-source','filter-score','filter-agent','filter-horizon']
        .forEach(id => el(id).value='');
    applyFilters();
};

// â”€â”€ RENDER TABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable() {
    const level = ROLES[currentUserData.role]?.level || 0;
    if (!filteredLeads.length) {
        el('leads-tbody').innerHTML = `<tr><td colspan="9" class="text-center py-16 text-gray-400">
            <div class="text-5xl mb-3">ğŸ¯</div><p>Niciun lead gÄƒsit.</p></td></tr>`;
        return;
    }
    el('leads-tbody').innerHTML = filteredLeads.map(l => {
        const sc  = STATUS_COLORS[l.status] || 'bg-gray-100 text-gray-700';
        const ico = SOURCE_ICONS[l.source]  || 'ğŸ“Œ';
        const val = parseFloat(l.estimatedValue||0).toLocaleString('ro-RO',{maximumFractionDigits:0});
        return `
        <tr class="hover:bg-orange-50 transition-colors cursor-pointer" onclick="viewLead('${l.id}')">
            <td class="px-4 py-3 font-mono text-xs text-orange-700 font-semibold">${l.leadId||'â€”'}</td>
            <td class="px-4 py-3">
                <div class="font-semibold text-gray-900 text-sm">${l.companyName||'â€”'}</div>
                <div class="text-xs text-gray-500">${l.contactName||''}</div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-700">${ico} ${l.source||'â€”'}</td>
            <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-semibold ${sc}">${l.status||'â€”'}</span></td>
            <td class="px-4 py-3">${scoreBadge(l.score)}</td>
            <td class="px-4 py-3 text-sm font-semibold text-gray-800">${val ? val+' RON' : 'â€”'}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${l.horizon||'â€”'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 agent-col ${level<=2?'hidden':''}">${l.agentName||'â€”'}</td>
            <td class="px-4 py-3 text-right" onclick="event.stopPropagation()">
                <div class="flex justify-end gap-2">
                    <button onclick="viewLead('${l.id}')" title="Vezi" class="text-orange-600 hover:text-orange-800 text-lg">ğŸ‘ï¸</button>
                    <button onclick="editLead('${l.id}')" title="EditeazÄƒ" class="text-yellow-600 hover:text-yellow-800 text-lg">âœï¸</button>
                    <button onclick="deleteLead('${l.id}','${(l.companyName||'').replace(/'/g,'')}')" title="È˜terge" class="text-red-600 hover:text-red-800 text-lg">ğŸ—‘ï¸</button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

// â”€â”€ RENDER KANBAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKanban() {
    el('kanban-board').innerHTML = KANBAN_COLS.map(col => {
        const items = filteredLeads.filter(l => l.status === col);
        const totalVal = items.reduce((s,l)=>s+parseFloat(l.estimatedValue||0),0);
        const [borderCls, bgCls] = KANBAN_COLORS[col].split(' ');
        return `
        <div class="flex flex-col">
            <div class="rounded-t-xl px-4 py-3 border-t-4 ${borderCls} ${bgCls} border-x border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-gray-800 text-sm">${col}</h3>
                    <span class="bg-white text-gray-700 text-xs font-semibold px-2 py-1 rounded-full shadow">${items.length}</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">${totalVal.toLocaleString('ro-RO',{maximumFractionDigits:0})} RON</p>
            </div>
            <div class="flex-1 border-x border-b border-gray-200 rounded-b-xl p-2 space-y-2 min-h-48 ${bgCls}">
                ${items.length ? items.map(l=>`
                    <div onclick="viewLead('${l.id}')"
                         class="bg-white rounded-xl p-3 shadow hover:shadow-md transition-all cursor-pointer border border-gray-100">
                        <div class="font-mono text-xs text-orange-600 font-semibold mb-1">${l.leadId||'â€”'}</div>
                        <div class="font-semibold text-gray-800 text-sm">${l.companyName||'â€”'}</div>
                        <div class="text-xs text-gray-500">${l.contactName||''}</div>
                        <div class="flex justify-between items-center mt-2">
                            ${scoreBadge(l.score)}
                            <span class="text-xs text-gray-500">${SOURCE_ICONS[l.source]||'ğŸ“Œ'} ${l.source||''}</span>
                        </div>
                        <div class="text-xs text-green-700 font-semibold mt-1">${parseFloat(l.estimatedValue||0).toLocaleString('ro-RO',{maximumFractionDigits:0})} RON</div>
                    </div>`).join('')
                : `<div class="text-center py-8 text-gray-400 text-sm">FÄƒrÄƒ leaduri</div>`}
            </div>
        </div>`;
    }).join('');
}

// â”€â”€ TOGGLE VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.setView = (view) => {
    currentView = view;
    el('view-table').classList.toggle('hidden',  view !== 'table');
    el('view-kanban').classList.toggle('hidden', view !== 'kanban');
    el('btn-view-table').className  = `px-4 py-2 rounded-lg text-sm font-medium transition-all ${view==='table' ?'bg-orange-600 text-white':'text-gray-600 hover:bg-gray-100'}`;
    el('btn-view-kanban').className = `px-4 py-2 rounded-lg text-sm font-medium transition-all ${view==='kanban'?'bg-orange-600 text-white':'text-gray-600 hover:bg-gray-100'}`;
    view === 'table' ? renderTable() : renderKanban();
};

// â”€â”€ MODAL DETALII â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.viewLead = (id) => {
    const l = allLeads.find(x => x.id === id);
    if (!l) return;
    const sc  = STATUS_COLORS[l.status] || 'bg-gray-100 text-gray-700';
    const ico = SOURCE_ICONS[l.source]  || 'ğŸ“Œ';
    const dt  = l.createdAt?.toDate ? l.createdAt.toDate().toLocaleDateString('ro-RO') : 'â€”';
    el('modal-content').innerHTML = `
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <span class="font-mono text-sm text-orange-700 font-bold bg-orange-100 px-3 py-1 rounded-full">${l.leadId||'â€”'}</span>
                ${scoreBadge(l.score)}
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><p class="text-xs text-gray-500">Companie</p><p class="font-semibold">${l.companyName||'â€”'}</p></div>
                <div><p class="text-xs text-gray-500">PersoanÄƒ contact</p><p class="font-semibold">${l.contactName||'â€”'}</p></div>
                <div><p class="text-xs text-gray-500">Telefon</p><p class="font-semibold">${l.phone||'â€”'}</p></div>
                <div><p class="text-xs text-gray-500">Email</p><p class="font-semibold">${l.email||'â€”'}</p></div>
                <div><p class="text-xs text-gray-500">SursÄƒ</p><p class="font-semibold">${ico} ${l.source||'â€”'}</p></div>
                <div><p class="text-xs text-gray-500">Status</p><span class="px-2 py-1 rounded-full text-xs font-semibold ${sc}">${l.status||'â€”'}</span></div>
                <div><p class="text-xs text-gray-500">Campanie</p><p class="font-semibold">${l.campaign||'â€”'}</p></div>
                <div><p class="text-xs text-gray-500">Produs / Serviciu</p><p class="font-semibold">${l.product||'â€”'}</p></div>
                <div><p class="text-xs text-gray-500">Buget estimat</p><p class="font-semibold">${l.budget ? parseFloat(l.budget).toLocaleString('ro-RO')+' RON' : 'â€”'}</p></div>
                <div><p class="text-xs text-gray-500">Valoare potenÈ›ialÄƒ</p><p class="font-semibold text-green-700">${l.estimatedValue ? parseFloat(l.estimatedValue).toLocaleString('ro-RO')+' RON' : 'â€”'}</p></div>
                <div><p class="text-xs text-gray-500">Orizont achiziÈ›ie</p><p class="font-semibold">${l.horizon||'â€”'}</p></div>
                <div><p class="text-xs text-gray-500">Agent</p><p class="font-semibold">${l.agentName||'â€”'}</p></div>
                <div><p class="text-xs text-gray-500">Data creare</p><p class="font-semibold">${dt}</p></div>
            </div>
            ${l.notes ? `<div><p class="text-xs text-gray-500 mb-1">NotiÈ›e</p>
                <p class="text-sm bg-gray-50 rounded-xl p-3">${l.notes}</p></div>` : ''}
        </div>`;
    el('modal-edit-btn').onclick    = () => { closeModal(); editLead(id); };
    el('modal-convert-btn').onclick = () => { closeModal(); openConvertModal(id); };
    // DacÄƒ deja convertit, dezactiveazÄƒ butonul
    if (l.status === 'Convertit') {
        el('modal-convert-btn').disabled = true;
        el('modal-convert-btn').className = 'bg-gray-300 text-gray-500 px-4 py-2 rounded-lg text-sm font-medium cursor-not-allowed';
        el('modal-convert-btn').textContent = 'âœ… Deja convertit';
    }
    el('modal-lead').classList.remove('hidden');
};
window.closeModal = () => el('modal-lead').classList.add('hidden');
window.editLead   = id => window.location.href = `form.html?id=${id}`;
window.deleteLead = async (id, name) => {
    if (!confirm(`È˜tergi leadul "${name}"?`)) return;
    await deleteDoc(doc(db,'leads',id));
    toast('âœ… Lead È™ters.');
    allLeads = allLeads.filter(l=>l.id!==id);
    updateStats(allLeads);
    applyFilters();
};

// â”€â”€ CONVERSIE LEAD â†’ CLIENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openConvertModal = (id) => {
    convertLeadId = id;
    el('conv-location').value = '';
    el('conv-cui').value      = '';
    el('conv-notes').value    = '';
    el('modal-convert').classList.remove('hidden');
};
window.closeConvertModal = () => el('modal-convert').classList.add('hidden');

window.confirmConvert = async () => {
    if (!convertLeadId) return;
    const lead = allLeads.find(l => l.id === convertLeadId);
    if (!lead) return;

    try {
        // CreazÄƒ client nou Ã®n colecÈ›ia 'clients'
        await addDoc(collection(db,'clients'), {
            companyName:     lead.companyName || '',
            contactName:     lead.contactName || '',
            phone:           lead.phone       || '',
            email:           lead.email       || '',
            location:        el('conv-location').value.trim(),
            cui:             el('conv-cui').value.trim(),
            notes:           el('conv-notes').value.trim(),
            agentId:         lead.agentId         || '',
            agentName:       lead.agentName        || '',
            directorZonalId: lead.directorZonalId  || null,
            source:          lead.source           || '',
            convertedFromLead: convertLeadId,
            createdAt:       Timestamp.now(),
            active:          true
        });

        // MarcheazÄƒ lead-ul ca Convertit
        await updateDoc(doc(db,'leads',convertLeadId), {
            status: 'Convertit',
            convertedAt: Timestamp.now()
        });

        // ActualizeazÄƒ local
        allLeads = allLeads.map(l => l.id===convertLeadId ? {...l, status:'Convertit', score:calcScore({...l,status:'Convertit'})} : l);
        updateStats(allLeads);
        applyFilters();
        closeConvertModal();
        toast('âœ… Lead convertit Ã®n client cu succes!');
    } catch(e) {
        toast('âŒ Eroare: ' + e.message, false);
    }
};

// â”€â”€ EXPORT CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.exportCSV = () => {
    if (!filteredLeads.length) { toast('Nu existÄƒ date de exportat.', false); return; }
    const h = ['ID Lead','Companie','Contact','Telefon','Email','SursÄƒ','Campanie','Produs','Status','Scor','Buget','Valoare Est.','Orizont','Agent','Data creare'];
    const r = filteredLeads.map(l => {
        const dt = l.createdAt?.toDate ? l.createdAt.toDate().toLocaleDateString('ro-RO') : '';
        return [l.leadId||'',l.companyName||'',l.contactName||'',l.phone||'',l.email||'',
                l.source||'',l.campaign||'',l.product||'',l.status||'',l.score||0,
                l.budget||'',l.estimatedValue||'',l.horizon||'',l.agentName||'',dt];
    });
    const csv = [h,...r].map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));
    a.download = `leaduri_${new Date().toLocaleDateString('ro-RO').replace(/\./g,'-')}.csv`;
    a.click();
    toast('âœ… Export realizat!');
};

el('filter-search').addEventListener('keydown', e => { if(e.key==='Enter') applyFilters(); });
</script>
</body>
</html>
